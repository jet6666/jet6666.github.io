var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(o,s){function r(t){try{h(n.next(t))}catch(e){s(e)}}function a(t){try{h(n["throw"](t))}catch(e){s(e)}}function h(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(r,a)}h((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return n([t,e])}}function n(i){if(o)throw new TypeError("Generator is already executing.");for(;h;)try{if(o=1,s&&(r=s[2&i[0]?"return":i[0]?"throw":"next"])&&!(r=r.call(s,i[1])).done)return r;switch(s=0,r&&(i=[0,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,s=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(r=h.trys,!(r=r.length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){h.label=i[1];break}if(6===i[0]&&h.label<r[1]){h.label=r[1],r=i;break}if(r&&h.label<r[2]){h.label=r[2],h.ops.push(i);break}r[2]&&h.ops.pop(),h.trys.pop();continue}i=e.call(t,h)}catch(n){i=[6,n],s=0}finally{o=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var o,s,r,a,h={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},AssetAdapter=function(){function t(){}return t.prototype.getAsset=function(t,e,i){function n(n){e.call(i,n,t)}if(RES.hasRes(t)){var o=RES.getRes(t);o?n(o):RES.getResAsync(t,n,this)}else RES.getResByUrl(t,n,this,RES.ResourceItem.TYPE_IMAGE)},t}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var DanmukuDemo=function(t){function e(){var e=t.call(this)||this;return e._size=22,e._speed=6,e._color=16711680,e.addEventListener("complete",e.onCompelte,e),e.skinName="DanmukuDemoSkin",e.addEventListener(egret.TouchEvent.TOUCH_TAP,e.onTouch,e),e}return __extends(e,t),Object.defineProperty(e.prototype,"danmu",{get:function(){return DanMaKuManager.getInstance()},enumerable:!0,configurable:!0}),e.prototype.onCompelte=function(t){this.danmu.init(this._DanmukuGroup),this._Size.minimum=22,this._Size.maximum=50,this._Size.value=1,this._Size.addEventListener(eui.UIEvent.CHANGE,this.change1,this),this._Speed.minimum=6,this._Speed.maximum=36,this._Speed.value=2,this._Speed.addEventListener(eui.UIEvent.CHANGE,this.change2,this),this._Color.minimum=16711680,this._Color.maximum=16777215,this._Color.value=10,this._Color.addEventListener(eui.UIEvent.CHANGE,this.change3,this),this._Txt.textColor=16711680},e.prototype.change1=function(t){this._size=t.target.value},e.prototype.change2=function(t){this._speed=t.target.value},e.prototype.change3=function(t){this._color=t.target.value,this._Txt.textColor=this._color},e.prototype.onTouch=function(t){switch(t.target){case this._SendBtn:this.danmu.add(this._Txt.text,this._color,this._size,this._speed/100);break;case this._ClearBtn:this.danmu.removeAll();break;case this._ResumeBtn:this.danmu.resume()}},e}(eui.Component);__reflect(DanmukuDemo.prototype,"DanmukuDemo");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Main=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.isThemeLoadEnd=!1,e.isResourceLoadEnd=!1,e}return __extends(e,t),e.prototype.createChildren=function(){t.prototype.createChildren.call(this);var e=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",e),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var e=new eui.Theme("resource/default.thm.json",this.stage);e.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),this.createScene()},e.prototype.onThemeLoadComplete=function(){this.isThemeLoadEnd=!0,this.createScene()},e.prototype.createScene=function(){this.isThemeLoadEnd&&this.startCreateScene()},e.prototype.startCreateScene=function(){var t=new DanmukuDemo;this.addChild(t)},e}(eui.UILayer);__reflect(Main.prototype,"Main");var ThemeAdapter=function(){function t(){}return t.prototype.getTheme=function(t,e,i,n){function o(t){e.call(n,t)}function s(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),i.call(n))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),RES.getResByUrl(t,o,this,RES.ResourceItem.TYPE_TEXT)},t}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var DanMaKuManager=function(){function t(){if(this._layer=new egret.DisplayObjectContainer,this._paddingY=130,this._maxLines=4,this._lineHeight=40,this._queueList=[],this._index=-1,this._data={},this._delayNum=0,t.instance)throw"DanMaKuManager inited ...."}return t.getInstance=function(){return t.instance||(t.instance=new t),t.instance},t.prototype.init=function(t){t.addChild(this._layer),this._layer.y=this._paddingY},t.prototype.add=function(t,e,i,n,o){return void 0===e&&(e=16777215),void 0===i&&(i=22),void 0===n&&(n=0),void 0===o&&(o=-1),__awaiter(this,void 0,void 0,function(){var s,r,a,h,u,l,c,_,d;return __generator(this,function(p){switch(p.label){case 0:return this._delayNum>=this._maxLines?(this._queueList.push([t,e,i,n]),[2]):(this._index++,r=0,a=0,h=-1==o?this._index:o,u=h%this._maxLines,l=Math.floor(h/this._maxLines),r=(u+1)*this._lineHeight,s=this._data[(l-1)*this._maxLines+u],0==n&&(n=.06),c=0,s?(c=100+s.txtWidth-s.speed*(this.nowTime-s.startTime),a=0>=c?0:Math.floor(c/n)):a=0,s=DanMaKuTxtInfo.create(t,e,r,n,i),0==a?s.startTime=this.nowTime:this._delayNum++,this._layer.addChild(s.text),this._data[h]=s,s.txtWidth=s.text.textWidth,[4,this.waitEvent(egret.Tween.get(s.text),a)]);case 1:return p.sent(),a>0&&this.startPlay(h,s,a),_=egret.MainContext.instance.stage.stageWidth,d=Math.floor((_+s.txtWidth)/n),[4,this.moveEvent(egret.Tween.get(s.text),{x:0-s.txtWidth},d)];case 2:return p.sent(),DanMaKuTxtInfo.release(s),this.playComplete(h),[2]}})})},t.prototype.waitEvent=function(t,e){return new Promise(function(i,n){t.wait(e).call(i,null)})},t.prototype.moveEvent=function(t,e,i){return new Promise(function(n,o){t.to(e,i).call(n,null)})},t.prototype.startPlay=function(t,e,i){if(e.startTime=this.nowTime,this._delayNum--,0!=this._queueList.length){var n=this._queueList.shift();this.add(n[0],n[1],n[2],n[3],t+this._maxLines)}},t.prototype.playComplete=function(t){this._data[t]=null,delete this._data[t]},t.prototype.removeAll=function(){this._queueList=[],this._layer.visible=!1},t.prototype.resume=function(){this._layer.visible=!0},Object.defineProperty(t.prototype,"nowTime",{get:function(){return(new Date).getTime()},enumerable:!0,configurable:!0}),t}();__reflect(DanMaKuManager.prototype,"DanMaKuManager");var DanMaKuTxtInfo=function(){function t(){this.startTime=0,this.speed=0,this.txtWidth=0,this.text=new egret.TextField}return t.init=function(){null==t.pool&&(t.pool=new game.pool.ObjectPool(!0),t.pool.allocate(1,t))},t.create=function(e,i,n,o,s){void 0===n&&(n=0),void 0===o&&(o=0),t.init();var r=t.pool.createObject(),a=egret.MainContext.instance.stage.stageWidth;return r.text.width=a,r.text.size=s,r.text.textAlign=egret.HorizontalAlign.LEFT,r.text.x=a,r.text.textFlow=(new egret.HtmlTextParser).parser(e+""),r.text.y=n,r.text.textColor=i,r.text.stroke=2,r.text.strokeColor=0,r.startTime=0,r.speed=o,r},t.release=function(e){null!=e&&null!=e.text&&(e.text.parent&&e.text.parent.removeChild(e.text),e.dispose(),t.init(),t.pool.releaseObject(e))},t.prototype.removeTween=function(){egret.Tween.removeTweens(this.text)},t.prototype.dispose=function(){this.text&&(this.text.textColor=16777215,this.text.size=22)},t.pool=null,t}();__reflect(DanMaKuTxtInfo.prototype,"DanMaKuTxtInfo",["game.interfaces.IDispose"]);var game;!function(t){var e;!function(t){var e=function(){function t(t){void 0===t&&(t=!1),this._sizeInit=0,this._sizeCurrent=0,this._usageCount=0,this._grow=!0,this._grow=t}return t.prototype.clear=function(){for(var t,e=this._headNode;null!=e;)t=e.next,e.next=null,e.data=null,e=t;this._headNode=this._tailNode=this._emptyNode=this._allocNode=null},t.prototype.size=function(){return this._sizeCurrent},t.prototype.usageCount=function(){return this._usageCount},t.prototype.wasteCount=function(){return this.size()-this.usageCount()},t.prototype.createObject=function(){if(this.usageCount()==this.size()){if(this._grow){var t=!1;this._sizeCurrent+=this._sizeInit;for(var e=null,n=this._tailNode,o=this._tailNode,s=0;s<this._sizeInit;s++)e=new i,e.data=this._factory.create(),o.next=e,o=e,this._sizeCurrent>100&&0==t&&(t=!0);return this._tailNode=o,this._tailNode.next=this._emptyNode=this._headNode,this._allocNode=n.next,this.createObject()}throw"对象池已经用完了"}var r=this._allocNode.data;return this._allocNode.data=null,this._allocNode=this._allocNode.next,this._usageCount++,r},t.prototype.releaseObject=function(t){this.usageCount()>0&&(this._usageCount--,this._emptyNode.data=t,this._emptyNode=this._emptyNode.next)},t.prototype.setFactory=function(t){this._factory=t},t.prototype.allocate=function(t,e){if(void 0===e&&(e=null),this.clear(),e)this._factory=new n(e);else if(!this._factory)throw"还未设置factory";this._sizeCurrent=this._sizeInit=t,this._headNode=this._tailNode=new i,this._headNode.data=this._factory.create();for(var o,s=1;s<this._sizeInit;s++)o=new i,o.data=this._factory.create(),o.next=this._headNode,this._headNode=o;this._emptyNode=this._allocNode=this._headNode,this._tailNode.next=this._headNode},t.prototype.initialze=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];for(var n,o=this._headNode;null!=o&&(n=o.data[t],n.apply(o.data,e),o!=this._tailNode);)o=o.next},t.prototype.purge=function(){var t,e=0;if(0==this.usageCount()){if(this._sizeCurrent==this._sizeInit)return;if(this._sizeCurrent>this._sizeInit){for(e=0,t=this._headNode;++e<this._sizeInit;)t=t.next;this._tailNode=t,this._allocNode=this._emptyNode=this._headNode,this._sizeCurrent=this._sizeInit}}else{var n=[];for(t=this._headNode;t&&(t.data||(n[e++]=t),t!=this._tailNode);)t=t.next;for(this._usageCount=this._sizeCurrent=n.length,this._tailNode=this._headNode=n[0],e=1;e<this._sizeCurrent;e++)t=n[e],t.next=this._headNode,this._headNode=t;if(this._allocNode=this._emptyNode=this._headNode,this._tailNode.next=this._headNode,this._usageCount<this._sizeInit){this._sizeCurrent=this._sizeInit;var o=this._tailNode,s=this._tailNode,r=this._sizeInit-this._usageCount;for(e=0;r>e;e++)t=new i,t.data=this._factory.create(),s.next=t,s=t;this._tailNode=s,this._tailNode.next=this._emptyNode=this._headNode,this._allocNode=o.next}}},t}();t.ObjectPool=e,__reflect(e.prototype,"game.pool.ObjectPool");var i=function(){function t(){}return t}();__reflect(i.prototype,"ObjectNode");var n=function(){function t(t){this._clazz=t}return t.prototype.create=function(){return new this._clazz},t}();__reflect(n.prototype,"SimpleFactory",["game.pool.IObjectPoolFactory"])}(e=t.pool||(t.pool={}))}(game||(game={}));